# エクセルファイル分析システム要件定義

## 1. システム概要
エクセルファイルの自由記載内容をLLMで分析し、特定の質問に基づいて情報を抽出するシステム。
ローカルのLLMサーバーを使用して、医療テキストから構造化された情報を抽出します。

## 2. 入力要件
### 2.1 入力ファイル形式
- Excelファイル（.xlsx）
- 必須列（列名は固定）：
  - ID列（列名: "ID"）
  - 日付列（列名: "day"）
  - 自由記載列（列名: "text"）

### 2.2 プロンプトテンプレート
- JSONファイル形式
- テンプレート構造：
  ```json
  {
    "template_key": {
      "name": "抽出項目名",
      "description": "説明",
      "system_prompt": "詳細な抽出ルール",
      "analysis_type": "extract/binary"
    }
  }
  ```

### 2.3 サンプルデータ形式
```excel
ID, day, text
1, 2023-01-01, "腫瘍径は15mm、StageIIの乳がんと診断"
1, 2023-02-01, "化学療法後、腫瘍径は8mmに縮小"
2, 2023-01-15, "StageIIIの肺がん、腫瘍径25mm"
```

## 3. 処理要件
### 3.1 ファイル読み込み処理
- pandasを使用してExcelファイルを読み込む
- 必須列の存在チェック
- 列名の厳密なバリデーション

### 3.2 データ前処理
- 同一IDの自由記載を日付順に結合
- 結合方法：
  - 日付の古い順に自由記載を連結
  - 各記載の間に日付情報を含める
  - 例：
    ```
    [2023-01-01]
    1回目の記載内容
    [2023-01-15]
    2回目の記載内容
    ```

### 3.3 LLM分析処理
- vLLMを使用したローカルLLMサーバー
- 分析タイプ：
  - 情報抽出モード：指定された情報を抽出
  - 真偽判定モード：特定の条件の有無を判定
- カスタムプロンプトテンプレートのサポート
- テキスト長制限（4000文字）の自動処理

## 4. 出力要件
### 4.1 分析結果
- ID単位で分析結果を保持
- 分析結果の形式：
  - 情報抽出の場合：抽出された情報（文字列）
  - 真偽判定の場合：True/False
- 結果をデータフレームとして表示

### 4.2 結果の保存
- 分析結果を新しいExcelファイルとして保存
- ファイル名規則：元のファイル名 + "_analyzed"
- 列の並び順：
  1. 基本列（ID、day、text）
  2. 分析結果列
  3. その他の列
- 分析結果の概要レポート表示：
  - 総データ数
  - ユニークな値の数
  - 未検出(N/A)の数
  - 主な抽出結果（上位5件）

## 5. 非機能要件
### 5.1 パフォーマンス
- LLMのAPIコール回数を最適化（ID単位の処理）
- API呼び出し間隔の制御（0.5秒の待機時間）
- 大規模テキストの自動トリミング

### 5.2 エラーハンドリング
- ファイル形式不正の検出
- 必須列欠損のチェック
- LLM API通信エラーの処理
- 結合テキストが長すぎる場合の処理
- 分析失敗時のフォールバック値の設定

### 5.3 環境要件
- Python 3.8以上
- CUDA対応GPU
- 十分なGPUメモリ（最低16GB推奨）

## 6. セットアップと使用方法
### 6.1 必要なパッケージのインストール
```bash
pip install pandas openpyxl vllm fastapi uvicorn requests
```

### 6.2 ローカルLLMサーバーの起動
```bash
python llm_server.py
```
- サーバーは http://localhost:8000 で起動します
- 初回起動時に日本語モデル（ELYZA-japanese-Llama-2-7b-instruct）がダウンロードされます

### 6.3 使用例
#### サンプルデータの準備
```excel
ID, day, text
1, 2023-01-01, "腫瘍径は15mm、StageIIの乳がんと診断"
1, 2023-02-01, "化学療法後、腫瘍径は8mmに縮小"
2, 2023-01-15, "StageIIIの肺がん、腫瘍径25mm"
```

#### Pythonコードでの実行
```python
from excel_analyzer import ExcelAnalyzer

# アナライザーの初期化
analyzer = ExcelAnalyzer("sample_data.xlsx")

# ファイル読み込み
analyzer.load_excel()

# ステージ情報の抽出
analyzer.analyze_with_llm(
    question="がんのステージを抽出してください",
    analysis_type="extract"
)

# 腫瘍サイズの抽出
analyzer.analyze_with_llm(
    question="腫瘍のサイズを数値（mm）で抽出してください",
    analysis_type="extract"
)

# 結果の保存
analyzer.save_results()
```

### 6.4 出力例
```
分析結果の概要:
- 分析結果_がんのステージ:
  総データ数: 3
  ユニークな値の数: 2
  未検出(N/A)の数: 0
  主な抽出結果:
    - StageII: 1件
    - StageIII: 1件

- 分析結果_腫瘍のサイズ:
  総データ数: 3
  ユニークな値の数: 3
  未検出(N/A)の数: 0
  主な抽出結果:
    - 8mm: 1件
    - 15mm: 1件
    - 25mm: 1件
```

### 6.5 注意事項
- GPUメモリが十分にある環境が必要です
- テキストの長さは4000文字までに制限されています
- 長いテキストは最新部分が優先して使用されます
- 分析結果は元のExcelファイル名に "_analyzed" を付加して保存されます 