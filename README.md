# 医療テキスト分析システム

## 概要
このシステムは、医療記録などの時系列テキストデータを分析し、重要な医療情報を自動抽出するツールです。

### 主な機能
1. **ダミーデータ生成**
2. **LLMによるテキスト分析機能**
3. **データ管理**
   - Excel形式での入出力
   - 患者IDごとの時系列データの統合
   - 分析結果の構造化保存
4. **カスタマイズ**
   - プロンプトテンプレートのカスタマイズ
   - 診療科別の分析ルールの設定
   - 出力形式の調整

## 分析手順

### 1. データの準備と前処理
1. **データ形式の確認**
   - 必須列（ID、日付、テキスト）の存在確認

2. **時系列データの統合**
   - 患者IDごとにテキストを時系列で結合して、ひとつながりの文章にする

### 2. LLMによる分析プロセス
1. **テンプレート選択**
   - 分析目的に応じたプロンプトテンプレートの選択

2. **情報抽出**
   - がん診断名の抽出
   - ステージ情報の特定
   - 治療内容の把握
   - 特記事項の抽出

3. **結果の検証**
   - 抽出結果の妥当性確認
   - 欠損や異常値のチェック

### 3. 分析結果の整理
1. **構造化データへの変換**
   - 抽出情報のカテゴリ分類
   - 時系列情報の整理

2. **出力形式の調整**
   - Excel形式での保存
   - 分析レポートの生成

## 開発におけるエンジニアと医師の協力

このシステムの開発と改善には、エンジニアと医師の緊密な協力が不可欠です。両者の専門知識を組み合わせることで、より実用的で信頼性の高いシステムを実現できます。

## ファイル構成
- `src/analyzer/excel_analyzer.py`: メインの分析エンジン
- `src/analyzer/llm_server.py`: ローカルLLMサーバー（vLLM使用）
- `templates/prompt_templates.json`: 分析用プロンプトテンプレート
- `examples/test_excel_analyzer.py`: 使用例とサンプルコード
- `examples/test_data_generator.py`: ダミーデータ生成用サンプルコード
- `notebooks/medical_text_analyzer.ipynb`: 対話的分析用ノートブック
- `notebooks/medical_data_generator.ipynb`: ダミーデータ生成用ノートブック
- `requirements.txt`: パッケージ依存関係
- `requirements.md`: 詳細な要件定義

## セットアップ手順

### 1. 環境要件
### 2. リポジトリのクローンとパッケージのインストール

# パッケージのインストール
pip install -r requirements.txt
```
## 実行方法

### 1. コマンドラインでの実行

#### LLMサーバーの起動

#### ダミーデータの生成
```bash
# データ生成の実行
python -m examples.test_data_generator
```

#### テキスト分析の実行
```bash
# 分析の実行
python -m examples.test_excel_analyzer
```

### 2. Jupyter Notebookでの実行

#### Jupyterの起動
```bash
jupyter notebook
```

#### ダミーデータ生成（medical_data_generator.ipynb）
1. `notebooks/medical_data_generator.ipynb` を開く
2. 各セルを順番に実行
3. 生成されたデータは `data/` ディレクトリに保存

#### テキスト分析（medical_text_analyzer.ipynb）
1. `notebooks/medical_text_analyzer.ipynb` を開く
2. LLMサーバーが起動していることを確認
3. 各セルを順番に実行して分析を実施

### 3. プロンプトテンプレートのカスタマイズ
`templates/prompt_templates.json` で分析ルールを定義します：

```json
{
    "cancer_diagnosis": {
        "name": "がん診断名抽出",
        "description": "テキストからがんの診断名を抽出",
        "system_prompt": "医療テキストから、がんの診断名を抽出してください。",
        "analysis_type": "extract"
    },
    "cancer_stage": {
        "name": "がんステージ抽出",
        "description": "がんのステージ情報を抽出",
        "system_prompt": "医療テキストから、TNM分類やStageなどのステージ情報を抽出してください。",
        "analysis_type": "extract"
    }
}
```

## データ形式

### 入力データ形式
Excelファイルを以下の形式で準備します：

| ID | day | text |
|----|-----|------|
| 1 | 2023-01-01 | "初診時所見：子宮体部類内膜癌 Stage IA。内膜生検の病理結果では、類内膜癌 Grade 1。MRIにて筋層浸潤は認めず。開腹子宮全摘術の方針とする。" |
| 1 | 2023-01-15 | "術前検査：胸部CT、腹部造影CTにて遠隔転移なし。血液検査にて貧血（Hb 9.8）あり、術前に貧血改善を要する。" |
| 1 | 2023-02-01 | "手術記録：腹腔鏡下子宮全摘+両側付属器切除術施行。手術時間2時間45分、出血量150ml。腹腔内に播種なし。術中合併症なし。" |

### データ統合例
同一患者（ID）の記録は時系列で統合されます：

ID: 1 
-----------------------------
- 2023-01-01: 初診時所見：子宮体部類内膜癌 Stage IA。内膜生検の病理結果では、類内膜癌 Grade 1。MRIにて筋層浸潤は認めず。開腹子宮全摘術の方針とする。
- 2023-01-15: 術前検査：胸部CT、腹部造影CTにて遠隔転移なし。血液検査にて貧血（Hb 9.8）あり、術前に貧血改善を要する。
- 2023-02-01: 手術記録：腹腔鏡下子宮全摘+両側付属器切除術施行。手術時間2時間45分、出血量150ml。腹腔内に播種なし。術中合併症なし。

### LLMへの入力テキスト
```
「初診時所見：子宮体部類内膜癌 Stage IA。内膜生検の病理結果では、類内膜癌 Grade 1。MRIにて筋層浸潤は認めず。開腹子宮全摘術の方針とする。
術前検査：胸部CT、腹部造影CTにて遠隔転移なし。血液検査にて貧血（Hb 9.8）あり、術前に貧血改善を要する。
手術記録：腹腔鏡下子宮全摘+両側付属器切除術施行。手術時間2時間45分、出血量150ml。腹腔内に播種なし。術中合併症なし。」
```


## 分析タイプ

### 1. 情報抽出モード（extract）
- 特定の情報を抽出（例：ステージ、サイズ）
- 出力形式は各テンプレートで規定
- 結果は文字列として保存
- 情報が見つからない場合は"N/A"

## 出力形式

### 1. Excelファイル
入力ファイルから「[ファイル名]_analyzed.xlsx」という名前で出力されます。

出力ファイルの形式:(もうすこし検討必要)

ID | day | text | 分析結果_がん診断名 | 分析結果_ステージ | 分析結果_診断検査 | 分析結果_初回治療 | 分析結果_化学療法 | 分析結果_術式 | 分析結果_特記事項
---|-----|------|-------------------|-----------------|-----------------|-----------------|------------------|-------------|----------------
1 | 2023-01-01 | 腫瘍径15mmの漿液性卵巣癌、StageIIICと診断... | 漿液性卵巣癌 | Stage IIIC | 検査名: 子宮内膜組織診, 実施日: 2023-01-10 | 日付: 2023-02-01, 種類: 手術, 内容: 腹腔鏡下子宮全摘術 | 開始日: 2023-02-15, レジメン: TC療法, 詳細: 3週毎 | 腹腔鏡下子宮全摘+両側付属器切除術 | 術後出血リスク高（抗凝固薬服用中）
2 | ... | ... | ... | ... | ... | ... | ... | ... | ...
3 | ... | ... | ... | ... | ... | ... | ... | ... | ...

※ 必要に応じて追加の列を含めることができます

- 各分析結果列の特徴：
  - 情報が見つからない場合は "N/A" を格納
  - 複数の情報がある場合は最新のものを採用
  - 日付情報は 'YYYY-MM-DD' 形式で統一
  - 区切り文字として ", " を使用

### 2. 分析レポート
```
分析結果の概要:
- 分析結果_がん診断名:
   総データ数: 10
   ユニークな値の数: 3
   未検出(N/A)の数: 0
   主な抽出結果:
     - 子宮体部類内膜癌: 3件
     - 漿液性卵巣癌: 4件
     - 高異型度漿液性癌: 3件

- 分析結果_初回治療:
   総データ数: 10
   ユニークな値の数: 3
   未検出(N/A)の数: 0
   主な抽出結果:
     - 手術: 5件
     - 化学療法: 3件
     - 放射線治療: 2件
```

## 制限事項
1. 列名の制約
   - ID列: "ID"
   - 日付列: "day"
   - テキスト列: "text"

2. テキスト制限
   - 最大4000文字
   - 超過分は切り捨て

3. 環境要件
   - GPU必須
   - 十分なメモリ


## ライセンス
- MITライセンス

## ディレクトリ構造
```
medical_text_analyzer/
├── src/
│   ├── analyzer/
│   │   ├── __init__.py
│   │   ├── excel_analyzer.py
│   │   └── llm_server.py
│   └── data/
│       ├── __init__.py
│       └── data_generator.py
├── notebooks/
│   ├── medical_data_generator.ipynb   # ダミーデータ生成用
│   └── medical_text_analyzer.ipynb    # テキスト分析実行用
├── examples/
│   ├── test_data_generator.py        # データ生成のサンプルコード
│   └── test_excel_analyzer.py        # 分析実行のサンプルコード
├── data/                             # 生成されたデータの保存先
│   └── .gitkeep
├── templates/                        # プロンプトテンプレート
│   └── prompt_templates.json
├── .gitignore                        # Git除外設定
├── LICENSE                           # MITライセンス
├── requirements.txt                  # パッケージ依存関係
├── requirements.md                   # 詳細な要件定義
└── README.md                         # このファイル
```

各ディレクトリの役割：
- `src/`: ソースコード
  - `analyzer/`: 分析関連のコア機能
  - `data/`: データ生成関連の機能
- `notebooks/`: 対話的な分析用Jupyterノートブック
- `examples/`: 使用例とサンプルコード
- `data/`: 生成データの保存先
- `templates/`: プロンプトテンプレート

